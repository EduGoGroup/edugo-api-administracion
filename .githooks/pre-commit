#!/bin/bash
# Pre-commit hook for edugo-api-administracion
# Runs: format check, lint, and unit tests before allowing commit

set -e

echo "üîç Ejecutando pre-commit hooks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local status=$1
    local message=$2
    if [ "$status" = "success" ]; then
        echo -e "${GREEN}‚úÖ $message${NC}"
    elif [ "$status" = "error" ]; then
        echo -e "${RED}‚ùå $message${NC}"
    elif [ "$status" = "warning" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  $message${NC}"
    else
        echo "$message"
    fi
}

# Check if we're in the right directory
if [ ! -f "go.mod" ]; then
    print_status "error" "No se encontr√≥ go.mod. ¬øEst√°s en la ra√≠z del proyecto?"
    exit 1
fi

# 1. Format check
echo ""
print_status "info" "Verificando formato del c√≥digo..."
UNFORMATTED=$(gofmt -l . 2>&1 | grep -v "^vendor/" || true)
if [ -n "$UNFORMATTED" ]; then
    print_status "error" "Archivos sin formatear encontrados:"
    echo "$UNFORMATTED"
    echo ""
    print_status "warning" "Ejecuta: make format"
    exit 1
fi
print_status "success" "Formato OK"

# 2. Lint
echo ""
print_status "info" "Ejecutando linter..."
if command -v golangci-lint &> /dev/null; then
    if make lint > /dev/null 2>&1; then
        print_status "success" "Lint OK"
    else
        print_status "error" "Lint fall√≥"
        print_status "warning" "Revisa los errores con: make lint"
        exit 1
    fi
else
    print_status "warning" "golangci-lint no encontrado, saltando lint"
    print_status "warning" "Instala con: brew install golangci-lint (macOS) o descarga desde https://golangci-lint.run"
fi

# 3. Unit tests
echo ""
print_status "info" "Ejecutando tests unitarios..."
if make test-unit > /dev/null 2>&1; then
    print_status "success" "Tests OK"
else
    print_status "error" "Tests fallaron"
    print_status "warning" "Revisa los errores con: make test-unit"
    exit 1
fi

# 4. Build check
echo ""
print_status "info" "Verificando build..."
if go build -v ./... > /dev/null 2>&1; then
    print_status "success" "Build OK"
else
    print_status "error" "Build fall√≥"
    exit 1
fi

echo ""
print_status "success" "‚ú® Todos los checks pasaron. Procediendo con commit..."
echo ""

exit 0
